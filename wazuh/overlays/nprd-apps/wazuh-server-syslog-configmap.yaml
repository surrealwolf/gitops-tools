# Wazuh Server Syslog Configuration
# XML fragment for syslog remote configuration
# This will be injected into ossec.conf by the initContainer
apiVersion: v1
kind: ConfigMap
metadata:
  name: wazuh-server-syslog-config
  namespace: managed-tools
  labels:
    app: wazuh
    component: server
    managed-by: gitops
data:
  syslog-remote.xml: |
    <!-- Syslog reception for UniFi and other external devices (port 5140 UDP) -->
    <!-- Using non-privileged port 5140 instead of 514 to avoid CAP_NET_BIND_SERVICE requirement -->
    <!-- Single remote block - traffic comes through proxy/NodePort which provides access control -->
    <!-- Allowed IPs: 0.0.0.0/0 (allow all) since proxy/NodePort already filters access -->
    <!-- Wazuh sees proxy/internal IP (10.x.x.x) or node IP (192.168.x.x) depending on traffic path -->
    <remote>
      <connection>syslog</connection>
      <port>5140</port>
      <protocol>udp</protocol>
      <allowed-ips>0.0.0.0/0</allowed-ips>
    </remote>
  
  inject-syslog.sh: |
    #!/bin/bash
    set -e
    
    OSSEC_CONF="/var/ossec/etc/ossec.conf"
    SYSLOG_FRAGMENT="/tmp/syslog-remote.xml"
    
    echo "Injecting syslog remote configuration into ossec.conf..."
    
    # Check if ossec.conf exists
    if [ ! -f "$OSSEC_CONF" ]; then
      echo "ERROR: ossec.conf not found at $OSSEC_CONF"
      exit 1
    fi
    
    # Check if syslog remote block already exists
    if grep -q '<connection>syslog</connection>' "$OSSEC_CONF"; then
      echo "Syslog remote configuration already exists, skipping..."
      exit 0
    fi
    
    # Find the position before </ossec_config> tag
    # Insert syslog remote block before the closing tag
    # Use Python for safe XML manipulation
    python3 << 'PYTHON_SCRIPT'
    import xml.etree.ElementTree as ET
    import sys
    import re
    
    ossec_conf = "/var/ossec/etc/ossec.conf"
    syslog_fragment = "/tmp/syslog-remote.xml"
    
    # Parse the syslog fragment
    with open(syslog_fragment, 'r') as f:
        syslog_xml = f.read().strip()
    
    # Read the ossec.conf file
    with open(ossec_conf, 'r') as f:
        content = f.read()
    
    # Check if syslog remote already exists
    if '<connection>syslog</connection>' in content:
        print("Syslog remote configuration already exists")
        sys.exit(0)
    
    # Find the closing </ossec_config> tag and insert before it
    # We need to preserve XML structure, so we'll use a simple text replacement
    # that maintains the closing tag position
    pattern = r'(</ossec_config>)'
    
    # The syslog fragment should be indented to match the ossec_config level
    # Find the indentation of </ossec_config>
    match = re.search(r'(\s+)</ossec_config>', content)
    if match:
        indent = match.group(1)
        # Indent the syslog fragment
        indented_syslog = '\n' + '\n'.join([indent + line if line.strip() else line 
                                           for line in syslog_xml.split('\n')])
        # Insert before closing tag
        new_content = re.sub(pattern, indented_syslog + r'\n\1', content, count=1)
    else:
        # Fallback: just insert before </ossec_config>
        new_content = content.replace('</ossec_config>', syslog_xml + '\n</ossec_config>')
    
    # Write back
    with open(ossec_conf, 'w') as f:
        f.write(new_content)
    
    print("Successfully injected syslog remote configuration")
    PYTHON_SCRIPT
    
    echo "Verifying ossec.conf XML validity..."
    python3 -c "
    import xml.etree.ElementTree as ET
    try:
        ET.parse('$OSSEC_CONF')
        print('✅ ossec.conf is valid XML')
    except ET.ParseError as e:
        print(f'❌ XML Error: {e}')
        exit(1)
    "
    
    echo "Syslog configuration injected successfully!"
