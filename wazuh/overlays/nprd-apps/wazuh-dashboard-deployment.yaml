# Wazuh Dashboard Deployment
#
# This is a placeholder. Replace with actual Wazuh Dashboard Deployment
# from the official wazuh-kubernetes repository.
#
# Key requirements:
# - Stateless deployment (no persistent storage needed)
# - Mount TLS certificates from secret
# - Set appropriate resource limits
# - Connect to wazuh-indexer service
#
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wazuh-dashboard
  namespace: managed-tools
  labels:
    app: wazuh
    component: dashboard
    managed-by: gitops
spec:
  replicas: 1
  selector:
    matchLabels:
      app: wazuh
      component: dashboard
  template:
    metadata:
      labels:
        app: wazuh
        component: dashboard
        managed-by: gitops
    spec:
      initContainers:
      - name: keystore-setup
        image: busybox:latest
        command: ['sh', '-c']
        args:
        - |
          mkdir -p /keystore-target
          chmod 755 /keystore-target
          chown 1000:1000 /keystore-target
          ls -la /keystore-target/
        securityContext:
          runAsUser: 0
        volumeMounts:
        - name: keystore
          mountPath: /keystore-target
      - name: wazuh-config-setup
        image: busybox:latest
        command: ['sh', '-c']
        args:
        - |
          # Create directory structure
          mkdir -p /wazuh-config/data/wazuh/config
          # Copy our config file
          cp /config-source/wazuh.yml /wazuh-config/data/wazuh/config/wazuh.yml
          # Set proper ownership and permissions
          chown -R 1000:1000 /wazuh-config
          chmod -R 755 /wazuh-config
          chmod 644 /wazuh-config/data/wazuh/config/wazuh.yml
          echo "Config file copied and permissions set"
          ls -la /wazuh-config/data/wazuh/config/
          cat /wazuh-config/data/wazuh/config/wazuh.yml | grep -A 5 "hosts:"
        securityContext:
          runAsUser: 0
        volumeMounts:
        - name: wazuh-config-source
          mountPath: /config-source
          readOnly: true
        - name: wazuh-config-persistent
          mountPath: /wazuh-config
      containers:
      - name: wazuh-dashboard
        image: wazuh/wazuh-dashboard:4.14.1
        # Using 4.14.1 (latest) - SecurityManager disabled by default since 4.12.0+
        # CPU compatibility: Works with 'host' CPU type (Proxmox VMs configured)
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
        ports:
        - containerPort: 5601
          name: http
        env:
        - name: OPENSEARCH_HOSTS
          value: "https://wazuh-indexer:9200"
        - name: SERVER_PORT
          value: "5601"
        - name: SERVER_SSL_ENABLED
          value: "false"
        volumeMounts:
        - name: config
          mountPath: /usr/share/wazuh-dashboard/config/opensearch_dashboards.yml
          subPath: opensearch_dashboards.yml
          readOnly: true
        - name: certs
          mountPath: /usr/share/wazuh-dashboard/certs/cert.pem
          subPath: dashboard.pem
          readOnly: true
        - name: certs
          mountPath: /usr/share/wazuh-dashboard/certs/key.pem
          subPath: dashboard-key.pem
          readOnly: true
        - name: certs
          mountPath: /usr/share/wazuh-dashboard/certs/root-ca.pem
          subPath: root-ca.pem
          readOnly: true
        - name: keystore
          mountPath: /etc/wazuh-dashboard
        - name: wazuh-config-persistent
          mountPath: /usr/share/wazuh-dashboard/data
      volumes:
      - name: config
        configMap:
          name: wazuh-dashboard-config
      - name: certs
        secret:
          secretName: wazuh-certs
      - name: keystore
        emptyDir: {}
      - name: wazuh-config-source
        configMap:
          name: wazuh-dashboard-wazuh-config
      - name: wazuh-config-persistent
        emptyDir: {}