# Wazuh Dashboard Deployment
#
# This is a placeholder. Replace with actual Wazuh Dashboard Deployment
# from the official wazuh-kubernetes repository.
#
# Key requirements:
# - Stateless deployment (no persistent storage needed)
# - Mount TLS certificates from secret
# - Set appropriate resource limits
# - Connect to wazuh-indexer service
#
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wazuh-dashboard
  namespace: managed-tools
  labels:
    app: wazuh
    component: dashboard
    managed-by: gitops
spec:
  replicas: 1
  selector:
    matchLabels:
      app: wazuh
      component: dashboard
  template:
    metadata:
      labels:
        app: wazuh
        component: dashboard
        managed-by: gitops
    spec:
      initContainers:
      - name: keystore-setup
        image: busybox:latest
        command: ['sh', '-c']
        args:
        - |
          mkdir -p /keystore-target
          touch /keystore-target/opensearch_dashboards.keystore
          chmod 644 /keystore-target/opensearch_dashboards.keystore
          chown 1000:1000 /keystore-target/opensearch_dashboards.keystore
          ls -la /keystore-target/
        securityContext:
          runAsUser: 0
        volumeMounts:
        - name: keystore
          mountPath: /keystore-target
      containers:
      - name: wazuh-dashboard
        image: wazuh/wazuh-dashboard:4.14.1
        # Using 4.14.1 (latest) - SecurityManager disabled by default since 4.12.0+
        # CPU compatibility: Works with 'host' CPU type (Proxmox VMs configured)
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
        ports:
        - containerPort: 5601
          name: http
        env:
        - name: OPENSEARCH_HOSTS
          value: "https://wazuh-indexer:9200"
        - name: SERVER_PORT
          value: "5601"
        - name: SERVER_SSL_ENABLED
          value: "false"
        volumeMounts:
        - name: config
          mountPath: /usr/share/wazuh-dashboard/config/opensearch_dashboards.yml
          subPath: opensearch_dashboards.yml
          readOnly: true
        - name: certs
          mountPath: /etc/wazuh-dashboard/certs/dashboard.pem
          subPath: wazuh-dashboard.pem
          readOnly: true
        - name: certs
          mountPath: /etc/wazuh-dashboard/certs/dashboard-key.pem
          subPath: wazuh-dashboard-key.pem
          readOnly: true
        - name: certs
          mountPath: /etc/wazuh-dashboard/certs/root-ca.pem
          subPath: root-ca.pem
          readOnly: true
        - name: keystore
          mountPath: /etc/wazuh-dashboard/opensearch_dashboards.keystore
          subPath: opensearch_dashboards.keystore
      volumes:
      - name: config
        configMap:
          name: wazuh-dashboard-config
      - name: certs
        secret:
          secretName: wazuh-certs
      - name: keystore
        emptyDir: {}