# Wazuh Dashboard Deployment
#
# This is a placeholder. Replace with actual Wazuh Dashboard Deployment
# from the official wazuh-kubernetes repository.
#
# Key requirements:
# - Stateless deployment (no persistent storage needed)
# - Mount TLS certificates from secret
# - Set appropriate resource limits
# - Connect to wazuh-indexer service
#
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wazuh-dashboard
  namespace: managed-tools
  labels:
    app: wazuh
    component: dashboard
    managed-by: gitops
spec:
  replicas: 1
  selector:
    matchLabels:
      app: wazuh
      component: dashboard
  template:
    metadata:
      labels:
        app: wazuh
        component: dashboard
        managed-by: gitops
    spec:
      initContainers:
      - name: keystore-setup
        image: busybox:latest
        command: ['sh', '-c']
        args:
        - |
          mkdir -p /keystore-target
          chmod 755 /keystore-target
          chown 1000:1000 /keystore-target
          ls -la /keystore-target/
        securityContext:
          runAsUser: 0
        volumeMounts:
        - name: keystore
          mountPath: /keystore-target
      - name: wazuh-config-setup
        image: busybox:latest
        command: ['sh', '-c']
        args:
        - |
          # Create directory structure at the correct location (Dashboard expects wazuh/config, not data/wazuh/config)
          mkdir -p /wazuh-config/wazuh/config
          mkdir -p /wazuh-config-backup/wazuh/config
          # Copy our config file to the correct location where Dashboard reads it
          cp /config-source/wazuh.yml /wazuh-config/wazuh/config/wazuh.yml
          cp /config-source/wazuh.yml /wazuh-config-backup/wazuh/config/wazuh.yml
          # Set proper ownership and permissions
          chown -R 1000:1000 /wazuh-config /wazuh-config-backup
          chmod -R 755 /wazuh-config /wazuh-config-backup
          chmod 644 /wazuh-config/wazuh/config/wazuh.yml
          chmod 644 /wazuh-config-backup/wazuh/config/wazuh.yml
          echo "Config file copied to /wazuh-config/wazuh/config/wazuh.yml (correct location)"
          ls -la /wazuh-config/wazuh/config/
        securityContext:
          runAsUser: 0
        volumeMounts:
        - name: wazuh-config-source
          mountPath: /config-source
          readOnly: true
        - name: wazuh-config-persistent
          mountPath: /wazuh-config
        - name: wazuh-config-backup
          mountPath: /wazuh-config-backup
      containers:
      - name: wazuh-dashboard
        image: wazuh/wazuh-dashboard:4.14.1
        # Using 4.14.1 (latest) - SecurityManager disabled by default since 4.12.0+
        # CPU compatibility: Works with 'host' CPU type (Proxmox VMs configured)
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          fsGroup: 1000
        ports:
        - containerPort: 5601
          name: http
        env:
        - name: OPENSEARCH_HOSTS
          value: "https://wazuh-indexer:9200"
        - name: SERVER_PORT
          value: "5601"
        - name: SERVER_SSL_ENABLED
          value: "false"
        volumeMounts:
        - name: config
          mountPath: /usr/share/wazuh-dashboard/config/opensearch_dashboards.yml
          subPath: opensearch_dashboards.yml
          readOnly: true
        - name: certs
          mountPath: /usr/share/wazuh-dashboard/certs/cert.pem
          subPath: dashboard.pem
          readOnly: true
        - name: certs
          mountPath: /usr/share/wazuh-dashboard/certs/key.pem
          subPath: dashboard-key.pem
          readOnly: true
        - name: certs
          mountPath: /usr/share/wazuh-dashboard/certs/root-ca.pem
          subPath: root-ca.pem
          readOnly: true
        - name: keystore
          mountPath: /etc/wazuh-dashboard
        - name: wazuh-config-persistent
          mountPath: /usr/share/wazuh-dashboard/data
        - name: wazuh-config-backup
          mountPath: /wazuh-config-backup
          readOnly: true
      - name: wazuh-config-watcher
        image: busybox:latest
        command: ['sh', '-c']
        args:
        - |
          echo "Starting wazuh-config watcher..."
          # Wait for Dashboard to create the directory structure
          sleep 20
          while true; do
            # Check if config file exists at the correct location (Dashboard reads from wazuh/config, not data/wazuh/config)
            if [ -f /wazuh-config/wazuh/config/wazuh.yml ]; then
              # Check if it contains our correct URL (https://wazuh-server without port in URL, and port field separately)
              if ! grep -q "url: https://wazuh-server$" /wazuh-config/wazuh/config/wazuh.yml 2>/dev/null || ! grep -q "port: 55000" /wazuh-config/wazuh/config/wazuh.yml 2>/dev/null; then
                echo "[$(date +%Y-%m-%d\ %H:%M:%S)] Config incorrect, restoring..."
                cp /wazuh-config-backup/wazuh/config/wazuh.yml /wazuh-config/wazuh/config/wazuh.yml
                chmod 644 /wazuh-config/wazuh/config/wazuh.yml
                chown 1000:1000 /wazuh-config/wazuh/config/wazuh.yml
                echo "[$(date +%Y-%m-%d\ %H:%M:%S)] Config restored successfully"
                # Verify it was restored
                if grep -q "url: https://wazuh-server$" /wazuh-config/wazuh/config/wazuh.yml && grep -q "port: 55000" /wazuh-config/wazuh/config/wazuh.yml; then
                  echo "Verified: Config correct"
                else
                  echo "ERROR: Config restoration failed"
                fi
              else
                echo "[$(date +%Y-%m-%d\ %H:%M:%S)] Config is correct"
              fi
            else
              echo "[$(date +%Y-%m-%d\ %H:%M:%S)] Config file not found yet, waiting..."
            fi
            sleep 15
          done
        securityContext:
          runAsUser: 0
        volumeMounts:
        - name: wazuh-config-persistent
          mountPath: /wazuh-config
        - name: wazuh-config-backup
          mountPath: /wazuh-config-backup
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: wazuh-dashboard-config
      - name: certs
        secret:
          secretName: wazuh-certs
      - name: keystore
        emptyDir: {}
      - name: wazuh-config-source
        configMap:
          name: wazuh-dashboard-wazuh-config
      - name: wazuh-config-persistent
        emptyDir: {}
      - name: wazuh-config-backup
        emptyDir: {}