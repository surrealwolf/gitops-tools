# Wazuh Server StatefulSet
# Based on official Wazuh Kubernetes manifests
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: wazuh-server
  namespace: managed-tools
  labels:
    app: wazuh
    component: server
    managed-by: gitops
spec:
  serviceName: wazuh-server
  replicas: 1
  selector:
    matchLabels:
      app: wazuh
      component: server
  template:
    metadata:
      labels:
        app: wazuh
        component: server
        managed-by: gitops
    spec:
      volumes:
        - name: wazuh-server-config
          configMap:
            name: wazuh-server-config
            defaultMode: 0640
        - name: filebeat-config
          configMap:
            name: wazuh-server-filebeat-config
        - name: indexer-certs
          secret:
            secretName: wazuh-certs
            defaultMode: 0600
      containers:
      - name: wazuh-server
        image: wazuh/wazuh-manager:4.14.1
        resources:
          limits:
            cpu: 2000m
            memory: 4Gi
          requests:
            cpu: 1000m
            memory: 2Gi
        ports:
          - containerPort: 1514
            name: agent-tcp
            protocol: TCP
          - containerPort: 1515
            name: agent-udp
            protocol: UDP
          - containerPort: 514
            name: syslog-udp
            protocol: UDP
          - containerPort: 55000
            name: api
            protocol: TCP
        volumeMounts:
          - name: logs
            mountPath: /var/ossec/logs
          - name: wazuh-server-config
            mountPath: /var/ossec/etc/ossec.conf
            subPath: ossec.conf
            readOnly: true
          - name: filebeat-config
            mountPath: /etc/filebeat/filebeat.yml
            subPath: filebeat.yml
            readOnly: true
          - name: indexer-certs
            mountPath: /etc/filebeat/certs/root-ca.pem
            subPath: root-ca.pem
            readOnly: true
  volumeClaimTemplates:
  - metadata:
      name: logs
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: truenas-nfs
      resources:
        requests:
          storage: 10Gi
