# Wazuh UniFi Decoder and Rules ConfigMap
# Custom decoders and rules for UniFi device logs
# These files will be copied to /var/ossec/etc/decoders/ and /var/ossec/etc/rules/
# by the initContainer, where Wazuh will auto-load them
apiVersion: v1
kind: ConfigMap
metadata:
  name: wazuh-unifi-decoder-config
  namespace: managed-tools
  labels:
    app: wazuh
    component: server
    managed-by: gitops
data:
  # Custom decoder file (will be copied to /var/ossec/etc/decoders/custom/)
  unifi_decoders.xml: |
    <!-- UniFi Decoders for Wazuh -->
    <!-- Based on UniFi SIEM Integration Documentation: https://help.ui.com/hc/en-us/articles/33349041044119 -->
    <!-- UniFi exports logs in CEF (Common Event Format), not standard syslog -->
    <!-- CEF Format: CEF:Version|Vendor|Product|Version|SignatureID|Name|Severity|Extension -->
    
    <!-- Primary decoder: Matches CEF format messages from UniFi -->
    <!-- CEF messages start with "CEF:" followed by pipe-separated fields -->
    <decoder name="unifi-cef">
      <prematch>^CEF:</prematch>
      <type>syslog</type>
    </decoder>

    <!-- CEF parser: Extracts CEF header fields -->
    <!-- Format: CEF:Version|Vendor|Product|Version|SignatureID|Name|Severity|Extension -->
    <decoder name="unifi-cef-header">
      <parent>unifi-cef</parent>
      <regex offset="after_prematch">(\d+)\|([^|]+)\|([^|]+)\|([^|]+)\|([^|]+)\|([^|]+)\|([^|]+)\|(.+)$</regex>
      <order>cef_version,vendor,product,product_version,signature_id,event_name,severity,extension</order>
    </decoder>

    <!-- CEF extension parser: Extracts key-value pairs from extension field -->
    <!-- Extension format: key=value key2=value2 (space or pipe separated) -->
    <decoder name="unifi-cef-extensions">
      <parent>unifi-cef-header</parent>
      <regex>src=([^\s|]+)</regex>
      <order>src_ip</order>
    </decoder>

    <decoder name="unifi-cef-extensions-dst">
      <parent>unifi-cef-extensions</parent>
      <regex>dst=([^\s|]+)</regex>
      <order>dst_ip</order>
    </decoder>

    <decoder name="unifi-cef-extensions-user">
      <parent>unifi-cef-extensions-dst</parent>
      <regex>user=([^\s|]+)</regex>
      <order>user</order>
    </decoder>

    <decoder name="unifi-cef-extensions-category">
      <parent>unifi-cef-extensions-user</parent>
      <regex>category=([^\s|]+)</regex>
      <order>category</order>
    </decoder>

    <!-- Alternative decoder: Matches Ubiquiti vendor in CEF messages -->
    <decoder name="unifi-cef-ubiquiti">
      <parent>unifi-cef-header</parent>
      <regex>Ubiquiti</regex>
      <order>vendor</order>
    </decoder>

    <!-- Fallback decoder: Catch UniFi messages with standard syslog format -->
    <!-- Matches messages containing "unifi" (case-insensitive) in hostname or message -->
    <!-- This handles non-CEF messages or legacy formats -->
    <decoder name="unifi-syslog">
      <prematch>unifi</prematch>
      <type>syslog</type>
    </decoder>

    <decoder name="unifi-ubiquiti">
      <prematch>Ubiquiti|UniFi Network</prematch>
      <type>syslog</type>
    </decoder>

    <!-- Fallback decoder: Catch any message with "unifi" that doesn't match above patterns -->
    <!-- This ensures all UniFi messages are at least detected, even if not fully parsed -->
    <decoder name="unifi-fallback">
      <parent>unifi-syslog</parent>
      <regex offset="after_prematch">(.+)$</regex>
      <order>message</order>
    </decoder>

  # Custom rules file (will be copied to /var/ossec/etc/rules/custom/)
  unifi_rules.xml: |
    <!-- UniFi Rules for Wazuh -->
    <!-- Based on UniFi SIEM Integration Documentation: https://help.ui.com/hc/en-us/articles/33349041044119 -->
    <!-- UniFi exports logs in CEF (Common Event Format) -->
    <!-- Rule group for UniFi events -->
    <group name="unifi,">
      <!-- Base rule: Catch all CEF format UniFi messages -->
      <rule id="100001" level="3">
        <decoded_as>unifi-cef</decoded_as>
        <description>UniFi CEF event detected: $event_name from $product (severity: $severity)</description>
      </rule>

      <!-- Rule for Ubiquiti vendor in CEF messages -->
      <rule id="100010" level="3">
        <decoded_as>unifi-cef-ubiquiti</decoded_as>
        <if_sid>100001</if_sid>
        <description>UniFi CEF event from Ubiquiti: $event_name (severity: $severity)</description>
      </rule>

      <!-- Authentication events (CEF) -->
      <rule id="100011" level="5">
        <decoded_as>unifi-cef-header</decoded_as>
        <if_sid>100001</if_sid>
        <match>auth|login|logout|authentication</match>
        <description>UniFi authentication event: $event_name from $src_ip user=$user (severity: $severity)</description>
      </rule>

      <!-- User login events -->
      <rule id="100012" level="5">
        <decoded_as>unifi-cef-extensions-user</decoded_as>
        <if_sid>100011</if_sid>
        <match>login|Login|User Login</match>
        <description>UniFi user login: $user from $src_ip</description>
      </rule>

      <!-- User logout events -->
      <rule id="100013" level="4">
        <decoded_as>unifi-cef-extensions-user</decoded_as>
        <if_sid>100011</if_sid>
        <match>logout|Logout|User Logout</match>
        <description>UniFi user logout: $user from $src_ip</description>
      </rule>

      <!-- Security events (CEF) -->
      <rule id="100014" level="10">
        <decoded_as>unifi-cef-header</decoded_as>
        <if_sid>100001</if_sid>
        <match>security|Security|intrusion|attack|denied|blocked|failed</match>
        <description>UniFi security event: $event_name from $src_ip (severity: $severity)</description>
      </rule>

      <!-- High-severity security alerts -->
      <rule id="100015" level="12">
        <decoded_as>unifi-cef-extensions</decoded_as>
        <if_sid>100014</if_sid>
        <match>failed|denied|blocked|intrusion|attack|breach</match>
        <description>UniFi security alert: $event_name from $src_ip to $dst_ip (severity: $severity) - $extension</description>
      </rule>

      <!-- Wireless events (CEF) -->
      <rule id="100016" level="5">
        <decoded_as>unifi-cef-header</decoded_as>
        <if_sid>100001</if_sid>
        <match>wireless|WiFi|WLAN|SSID|client.*connect|client.*disconnect</match>
        <description>UniFi wireless event: $event_name (severity: $severity)</description>
      </rule>

      <!-- Network events (CEF) -->
      <rule id="100017" level="5">
        <decoded_as>unifi-cef-header</decoded_as>
        <if_sid>100001</if_sid>
        <match>network|Network|DHCP|DNS|route|connection</match>
        <description>UniFi network event: $event_name from $src_ip (severity: $severity)</description>
      </rule>

      <!-- System events (CEF) -->
      <rule id="100018" level="4">
        <decoded_as>unifi-cef-header</decoded_as>
        <if_sid>100001</if_sid>
        <match>system|System|reboot|startup|shutdown|update|firmware</match>
        <description>UniFi system event: $event_name (severity: $severity)</description>
      </rule>

      <!-- Category-based rules (CEF extension) -->
      <rule id="100019" level="5">
        <decoded_as>unifi-cef-extensions-category</decoded_as>
        <if_sid>100001</if_sid>
        <match>category=auth|category=authentication</match>
        <description>UniFi category: authentication - $event_name from $src_ip</description>
      </rule>

      <rule id="100020" level="10">
        <decoded_as>unifi-cef-extensions-category</decoded_as>
        <if_sid>100001</if_sid>
        <match>category=security|category=Security</match>
        <description>UniFi category: security - $event_name from $src_ip</description>
      </rule>

      <!-- Fallback: Standard syslog format messages (legacy or non-CEF) -->
      <rule id="100021" level="3">
        <decoded_as>unifi-syslog</decoded_as>
        <description>UniFi syslog event (non-CEF): $message</description>
      </rule>

      <rule id="100022" level="3">
        <decoded_as>unifi-ubiquiti</decoded_as>
        <description>UniFi/Ubiquiti event (non-CEF): $message</description>
      </rule>

      <!-- Fallback: Catch any UniFi message that doesn't match above patterns -->
      <rule id="100023" level="3">
        <decoded_as>unifi-fallback</decoded_as>
        <if_sid>100021</if_sid>
        <description>UniFi message (unstructured): $message</description>
      </rule>
    </group>
  
  # Script to copy decoders and rules to appropriate directories
  copy-custom-files.sh: |
    #!/bin/bash
    set -e
    
    echo "Copying UniFi decoders and rules to Wazuh directories..."
    
    DECODER_DIR="/var/ossec/etc/decoders/custom"
    RULES_DIR="/var/ossec/etc/rules/custom"
    
    # Create directories if they don't exist
    mkdir -p "$DECODER_DIR" "$RULES_DIR"
    
    # Copy decoder file
    if [ -f "/tmp/unifi_decoders.xml" ]; then
      cp /tmp/unifi_decoders.xml "$DECODER_DIR/unifi_decoders.xml"
      chmod 640 "$DECODER_DIR/unifi_decoders.xml"
      chown root:wazuh "$DECODER_DIR/unifi_decoders.xml"
      echo "✅ Copied unifi_decoders.xml to $DECODER_DIR"
    else
      echo "⚠️  unifi_decoders.xml not found, skipping..."
    fi
    
    # Copy rules file
    if [ -f "/tmp/unifi_rules.xml" ]; then
      cp /tmp/unifi_rules.xml "$RULES_DIR/unifi_rules.xml"
      chmod 640 "$RULES_DIR/unifi_rules.xml"
      chown root:wazuh "$RULES_DIR/unifi_rules.xml"
      echo "✅ Copied unifi_rules.xml to $RULES_DIR"
    else
      echo "⚠️  unifi_rules.xml not found, skipping..."
    fi
    
    echo "Custom decoders and rules deployed successfully!"
