# Wazuh UniFi Decoder and Rules ConfigMap
# Custom decoders and rules for UniFi device logs
# These files will be copied to /var/ossec/etc/decoders/ and /var/ossec/etc/rules/
# by the initContainer, where Wazuh will auto-load them
apiVersion: v1
kind: ConfigMap
metadata:
  name: wazuh-unifi-decoder-config
  namespace: managed-tools
  labels:
    app: wazuh
    component: server
    managed-by: gitops
data:
  # Custom decoder file (will be copied to /var/ossec/etc/decoders/custom/)
  unifi_decoders.xml: |
    <!-- UniFi Decoders for Wazuh -->
    <!-- Decoder for UniFi log format -->
    <decoder name="unifi">
      <prematch>Ubiquiti\|UniFi Network</prematch>
      <type>syslog</type>
    </decoder>

    <decoder name="unifi-custom">
      <parent>unifi</parent>
      <regex offset="after_prematch">\|(\S+)\|(\d+)\|(.+)\|(\d+)\|UNIFIcategory=(\w+) UNIFIsubCategory=(\w+) UNIFIhost=(\w+) UNIFIsite=(\w+)</regex>
      <order>version,type,information,severity,UNIFIcategory,UNIFIsubCategory,UNIFIhost,UNIFIsite</order>
    </decoder>

    <!-- Alternative decoder for different UniFi log formats -->
    <decoder name="unifi-syslog">
      <prematch>^</prematch>
      <regex>(\w+\s+\d+\s+\d+:\d+:\d+)\s+(\S+)\s+unifi:\s+(.+)$</regex>
      <order>timestamp,hostname,message</order>
    </decoder>

  # Custom rules file (will be copied to /var/ossec/etc/rules/custom/)
  unifi_rules.xml: |
    <!-- UniFi Rules for Wazuh -->
    <!-- Rule group for UniFi events -->
    <group name="unifi,">
      <rule id="100001" level="3">
        <decoded_as>unifi</decoded_as>
        <description>UniFi event detected</description>
      </rule>

      <rule id="100002" level="5">
        <decoded_as>unifi-custom</decoded_as>
        <if_sid>100001</if_sid>
        <match>UNIFIcategory=auth</match>
        <description>UniFi authentication event: $UNIFIsubCategory from $UNIFIhost</description>
      </rule>

      <rule id="100003" level="10">
        <decoded_as>unifi-custom</decoded_as>
        <if_sid>100001</if_sid>
        <match>UNIFIcategory=security</match>
        <description>UniFi security event: $UNIFIsubCategory on $UNIFIhost</description>
      </rule>

      <rule id="100004" level="12">
        <decoded_as>unifi-custom</decoded_as>
        <if_sid>100001</if_sid>
        <match>UNIFIcategory=security.*failed|denied|blocked</match>
        <description>UniFi security alert: $UNIFIsubCategory on $UNIFIhost</description>
      </rule>

      <rule id="100005" level="5">
        <decoded_as>unifi-custom</decoded_as>
        <if_sid>100001</if_sid>
        <match>UNIFIcategory=wireless</match>
        <description>UniFi wireless event: $UNIFIsubCategory on $UNIFIhost</description>
      </rule>
    </group>
  
  # Script to copy decoders and rules to appropriate directories
  copy-custom-files.sh: |
    #!/bin/bash
    set -e
    
    echo "Copying UniFi decoders and rules to Wazuh directories..."
    
    DECODER_DIR="/var/ossec/etc/decoders/custom"
    RULES_DIR="/var/ossec/etc/rules/custom"
    
    # Create directories if they don't exist
    mkdir -p "$DECODER_DIR" "$RULES_DIR"
    
    # Copy decoder file
    if [ -f "/tmp/unifi_decoders.xml" ]; then
      cp /tmp/unifi_decoders.xml "$DECODER_DIR/unifi_decoders.xml"
      chmod 640 "$DECODER_DIR/unifi_decoders.xml"
      chown root:wazuh "$DECODER_DIR/unifi_decoders.xml"
      echo "✅ Copied unifi_decoders.xml to $DECODER_DIR"
    else
      echo "⚠️  unifi_decoders.xml not found, skipping..."
    fi
    
    # Copy rules file
    if [ -f "/tmp/unifi_rules.xml" ]; then
      cp /tmp/unifi_rules.xml "$RULES_DIR/unifi_rules.xml"
      chmod 640 "$RULES_DIR/unifi_rules.xml"
      chown root:wazuh "$RULES_DIR/unifi_rules.xml"
      echo "✅ Copied unifi_rules.xml to $RULES_DIR"
    else
      echo "⚠️  unifi_rules.xml not found, skipping..."
    fi
    
    echo "Custom decoders and rules deployed successfully!"
