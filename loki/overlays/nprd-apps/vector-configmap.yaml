# Vector Configuration for Syslog Receiver
#
# Vector receives UniFi CEF syslog on UDP 514, parses CEF format,
# and forwards to Loki.
#
apiVersion: v1
kind: ConfigMap
metadata:
  name: vector-config
  namespace: managed-syslog
  labels:
    app: vector
    component: syslog
    managed-by: gitops
data:
  vector.yaml: |
    # Vector Configuration for UniFi CEF Syslog Ingestion
    
    # Enable API for health checks (on port 8686 to avoid conflict with prometheus_exporter)
    api:
      enabled: true
      address: "0.0.0.0:8686"
      playground: false
    
    sources:
      syslog_udp:
        type: socket
        mode: udp
        address: "0.0.0.0:514"
        framing:
          method: newline_delimited
      
      internal_metrics:
        type: internal_metrics
    
    transforms:
      parse_cef:
        type: remap
        inputs:
          - syslog_udp
        source: |
          # Handle raw socket data - extract message field
          message_text = string!(.message)
          # Check if message contains CEF (might have syslog prefix)
          cef_message = message_text
          if match(message_text, r'CEF:') {
            # Extract CEF portion if there's a syslog prefix
            cef_match = match(message_text, r'CEF:.*')
            if cef_match != null {
              cef_message = string!(cef_match)
            }
          }
          # Ensure cef_message is a string before using match()
          cef_message = string!(cef_message)
          if match(cef_message, r'^CEF:') {
            parts = split(cef_message, "|")
            if length(parts) >= 7 {
              if length(parts) > 1 { .device_vendor = parts[1] }
              if length(parts) > 2 { .device_product = parts[2] }
              if length(parts) > 3 { .device_version = parts[3] }
              if length(parts) > 4 { .signature_id = parts[4] }
              if length(parts) > 5 { .cef_name = parts[5] }
              if length(parts) > 6 {
                severity_str = parts[6]
                .severity, err = to_int(severity_str)
                if err != null {
                  .severity = 0
                }
              }
            }
            .source = "unifi-cef"
          }
          if exists(.hostname) { .syslog_hostname = .hostname }
          if exists(.facility) { .syslog_facility = .facility }
          .source_type = "syslog"
          .format = "cef"
    
    sinks:
      loki:
        type: loki
        inputs:
          - parse_cef
        endpoint: "http://loki-distributor:3100"
        path: "/loki/api/v1/push"
        encoding:
          codec: json
        labels:
          namespace: unifi
          app: unifi-cef
          source: syslog
          format: cef
        remove_label_fields: true
      
      prometheus_exporter:
        type: prometheus_exporter
        inputs:
          - internal_metrics
        address: "0.0.0.0:9598"
        default_namespace: vector
