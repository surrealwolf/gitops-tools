# Prometheus Agent Helm Chart Configuration - Base
#
# Deploys Prometheus Agent (lightweight) to collect and push metrics to central Prometheus
# Official repository: https://prometheus-community.github.io/helm-charts
# Chart: https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus
#
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: prometheus-agent
  namespace: managed-syslog
spec:
  chart: prometheus
  repo: https://prometheus-community.github.io/helm-charts
  targetNamespace: managed-syslog
  valuesContent: |-
    # Prometheus Agent Configuration - Base
    # Override in cluster overlays with specific remote write endpoint and cluster labels
    
    # Use Prometheus Agent mode (not full Prometheus)
    # Agent mode is lightweight and designed for remote write scenarios
    agent:
      enabled: true
      
    # Disable full Prometheus
    server:
      enabled: false
    
    # Prometheus Agent configuration
    config:
      global:
        # Cluster label - OVERRIDE in cluster overlay
        external_labels:
          cluster: "default"
      
      # Remote write endpoint - OVERRIDE in cluster overlay
      # Default: internal service (for nprd-apps cluster)
      # External clusters: use external URL
      remote_write:
        - url: http://prometheus-kube-prometheus-prometheus.managed-syslog.svc.cluster.local:9090/api/v1/write
          queue_config:
            max_samples_per_send: 1000
            max_shards: 200
            capacity: 2500
      
      # Scrape configurations
      scrape_configs:
        # Scrape node-exporter
        - job_name: 'node-exporter'
          kubernetes_sd_configs:
            - role: endpoints
              namespaces:
                names:
                  - managed-syslog
          relabel_configs:
            - source_labels: [__meta_kubernetes_endpoints_name]
              regex: 'prometheus-node-exporter'
              action: keep
            - source_labels: [__meta_kubernetes_endpoint_address_target_name]
              target_label: instance
            - replacement: 'node-exporter'
              target_label: job
        
        # Scrape kube-state-metrics
        - job_name: 'kube-state-metrics'
          kubernetes_sd_configs:
            - role: endpoints
              namespaces:
                names:
                  - managed-syslog
          relabel_configs:
            - source_labels: [__meta_kubernetes_endpoints_name]
              regex: 'prometheus-kube-state-metrics'
              action: keep
            - source_labels: [__meta_kubernetes_endpoint_address_target_name]
              target_label: instance
            - replacement: 'kube-state-metrics'
              target_label: job
    
    # Resources - base configuration
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    
    # Service account
    serviceAccount:
      create: true
    
    # Image configuration - using Harbor registry
    image:
      registry: harbor.dataknife.net
      repository: dockerhub/prom/prometheus
      tag: "v2.51.2"  # Latest stable version