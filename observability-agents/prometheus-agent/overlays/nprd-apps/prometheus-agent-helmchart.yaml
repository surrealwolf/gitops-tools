# Prometheus Agent Helm Chart Configuration - nprd-apps Overlay
#
# Cluster-specific configuration for nprd-apps cluster
# Uses internal service endpoint since Prometheus is on the same cluster
#
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: prometheus-agent
  namespace: managed-syslog
spec:
  chart: prometheus
  repo: https://prometheus-community.github.io/helm-charts
  targetNamespace: managed-syslog
  valuesContent: |-
    # Prometheus Agent Configuration - nprd-apps
    # Uses internal service endpoint since Prometheus is on the same cluster
    
    agent:
      enabled: true
    
    server:
      enabled: false
    
    config:
      global:
        external_labels:
          cluster: "nprd-apps"
      
      # Internal Prometheus endpoint (same cluster)
      remote_write:
        - url: http://prometheus-kube-prometheus-prometheus.managed-syslog.svc.cluster.local:9090/api/v1/write
          queue_config:
            max_samples_per_send: 1000
            max_shards: 200
            capacity: 2500
      
      scrape_configs:
        - job_name: 'node-exporter'
          kubernetes_sd_configs:
            - role: endpoints
              namespaces:
                names:
                  - managed-syslog
          relabel_configs:
            - source_labels: [__meta_kubernetes_endpoints_name]
              regex: 'prometheus-node-exporter'
              action: keep
            - source_labels: [__meta_kubernetes_endpoint_address_target_name]
              target_label: instance
            - replacement: 'node-exporter'
              target_label: job
        
        - job_name: 'kube-state-metrics'
          kubernetes_sd_configs:
            - role: endpoints
              namespaces:
                names:
                  - managed-syslog
          relabel_configs:
            - source_labels: [__meta_kubernetes_endpoints_name]
              regex: 'prometheus-kube-state-metrics'
              action: keep
            - source_labels: [__meta_kubernetes_endpoint_address_target_name]
              target_label: instance
            - replacement: 'kube-state-metrics'
              target_label: job
    
    # Resources for nprd-apps
    resources:
      requests:
        cpu: 500m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi
    
    serviceAccount:
      create: true
    
    image:
      registry: harbor.dataknife.net
      repository: dockerhub/prom/prometheus
      tag: "v2.51.2"