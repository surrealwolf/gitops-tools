# OpenSearch Cluster for Graylog - nprd-apps Overlay
#
# Deploys OpenSearch using the OpenSearch Kubernetes Operator
# Graylog 5.2 supports OpenSearch 2.x (tested up to 2.15)
#
apiVersion: opensearch.opster.io/v1
kind: OpenSearchCluster
metadata:
  name: graylog-opensearch
  namespace: managed-tools
  labels:
    app: graylog
    component: opensearch
    managed-by: gitops
    cluster: nprd-apps
spec:
  general:
    version: "2.19.2"  # Minimum supported by operator v2.8.0 (supports 2.19.2 to 3.x)
    serviceName: graylog-opensearch  # Service name for OpenSearch cluster
  security:
    config:
      adminCredentialsSecret:
        name: graylog-opensearch-admin-password  # Secret for operator access (post-bootstrap)
  nodePools:
    - component: masters
      replicas: 1
      roles:
        - master
        - data
      diskSize: "50Gi"
      env:
        - name: OPENSEARCH_INITIAL_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: graylog-opensearch-admin-password
              key: password
      resources:
        requests:
          cpu: "500m"
          memory: "2Gi"
        limits:
          cpu: "2000m"
          memory: "4Gi"
      persistence:
        pvc:
          storageClass: ""  # Use default storage class (truenas-nfs)
    - component: data
      replicas: 1
      roles:
        - data
      diskSize: "250Gi"  # Sized for 2 weeks retention from 2 UniFi instances + growth
      env:
        - name: OPENSEARCH_INITIAL_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: graylog-opensearch-admin-password
              key: password
      resources:
        requests:
          cpu: "500m"
          memory: "2Gi"
        limits:
          cpu: "2000m"
          memory: "4Gi"
      persistence:
        pvc:
          storageClass: ""  # Use default storage class (truenas-nfs)
  dashboards:
    enable: false  # Disable OpenSearch Dashboards (Graylog provides UI)
    replicas: 0  # Required field (0 since disabled)
    version: "2.19.2"  # Required field (same as OpenSearch version)