# OpenSearch Bootstrap Password MutatingWebhookConfiguration
#
# This MutatingAdmissionWebhook automatically injects OPENSEARCH_INITIAL_ADMIN_PASSWORD
# into bootstrap pods when they are created.
#
# Prerequisites:
#   1. Webhook server deployment (opensearch-bootstrap-webhook-server.yaml)
#   2. TLS certificate (managed by cert-manager or manual)
#   3. CA bundle must be injected into caBundle field (after certificate creation)
#
# Certificate setup:
#   - Using cert-manager: Certificate resource creates secret, CA bundle extracted from secret
#   - Manual: Create TLS secret, extract CA bundle, update this file
#
# See OPENSEARCH_BOOTSTRAP_WORKAROUND.md for full documentation.

apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: opensearch-bootstrap-password-webhook
  labels:
    app: opensearch-bootstrap-webhook
    managed-by: gitops
    cluster: nprd-apps
webhooks:
  - name: opensearch-bootstrap-password.opensearch.local
    admissionReviewVersions:
      - v1
      - v1beta1
    sideEffects: None
    clientConfig:
      service:
        name: opensearch-bootstrap-webhook
        namespace: managed-graylog
        path: "/mutate"
        port: 443
      # CA bundle - Updated from certificate secret
      # Extracted from: kubectl get secret opensearch-bootstrap-webhook-cert -n managed-graylog -o jsonpath='{.data.ca\.crt}'
      # Note: If certificate is regenerated, this must be updated to match
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURMRENDQWhTZ0F3SUJBZ0lRU0l4cmtucDJXZEFYNzAwR1dzWUdHakFOQmdrcWhraUc5dzBCQVFzRkFEQUEKTUI0WERUSTJNREV4TVRBNU16UXpNRm9YRFRJMk1EUXhNVEE1TXpRek1Gb3dBRENDQVNJd0RRWUpLb1pJaHZjTgpBUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTHN6Y3F3TjFSdk5uejQwNHBnb0Qxa04xRENJMXB1c1hBZ3pSWkphCmtVQkJQZkVqdFB4ZU8vcWwyYkdrZXE5N3AxVkJtakZDRlY4ZXNLdTBVTjhkcDJaSGVmRzM2QjRNZjgzRStvQk8KQXJUajV4VEZ2UkEzWFFZVEFoSDJQWEdJMklMZHQ2VlBNcHR0dXBneEk2OUo2YXlDdTNmME5qNzBzOFFSQTRNaAp6SW1lbWwvZ1YweG1XcmtYU0NHbUVqdmdTWXBWVkdWa3ltZkJnQlhGMkM0UnlRZmdFUnlpKzllclBmQjQ3TXZECk85WGR0ZmI5ZmZ6TitKbFlVZ3k0dGxXY1BlS1dJSm8rdEJCMmR1ZzFLSUs4YUhaNkFWNWFCbWEzWVErb1V0Z1QKZFNSbW1qYXZ6ai9PT252Vms5d0xCd2d6NmoyQ2ZGZHZXanVUeGVXSnBIR1AvWjBDQXdFQUFhT0JvVENCbmpBTwpCZ05WSFE4QkFmOEVCQU1DQmFBd0RBWURWUjBUQVFIL0JBSXdBREIrQmdOVkhSRUJBZjhFZERCeWdqQnZjR1Z1CmMyVmhjbU5vTFdKdmIzUnpkSEpoY0MxM1pXSm9iMjlyTG0xaGJtRm5aV1F0WjNKaGVXeHZaeTV6ZG1PQ1BtOXcKWlc1elpXRnlZMmd0WW05dmRITjBjbUZ3TFhkbFltaHZiMnN1YldGdVlXZGxaQzFuY21GNWJHOW5Mbk4yWXk1agpiSFZ6ZEdWeUxteHZZMkZzTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElCQVFDamtuZ2FEQTAxQzZwVjR2VHNTRlJrCmhwZUw3anUwdHV0RXBUNzFFa1RCY2xnV1hJdzM1YlV1amJKZTNyYWdmRG5Uc1JsSUUzOGdxNE13dGZxcUpHMXMKUXFOdnJSVWRKTjVkeUN0cEpBVlN4ekpIUTArcVFJTEVsWGtaME1BMDdQTmRzd0QyUUorVjR6MXgwUUxWSDBCOAppNFNGUFRqYVhXMTRVZTI3OHRlNXpudVR3VVhSbldrclNrdUJNMG9sZ05sVlRyTTdFM21kMGtrNHBWMzU2VTQ1CkxaYlRTTmowSG15UmpxbndEMHBUZGU0NEFrbjJqekp6bkEzaUJtNUUvZzdtTmxXRnBMYjkzTkwzcUpZQkZDaHoKN2dxeFh5aHhicElTU0tkeWtxNVRDSmJLcDIwT0E2R3FtTGkybFJkc0kwUDJCWFJhelhQbjRQaVl5M1liRVNBNwotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    rules:
      - operations: ["CREATE"]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["pods"]
    # Match pods in managed-graylog namespace (webhook server filters by name pattern)
    namespaceSelector:
      matchLabels:
        name: managed-graylog
    # Exclude CA bundle injector job pods and webhook server pods (chicken-and-egg problem)
    # - Job pods need to run to inject CA bundle
    # - Webhook server pods need to run to provide endpoints, but webhook intercepts their creation
    objectSelector:
      matchExpressions:
      - key: component
        operator: NotIn
        values:
        - ca-bundle-injector
        - webhook-server