apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: managed-graylog

resources:
  # OpenSearch cluster (deployed via OpenSearch Kubernetes Operator)
  - opensearch-cluster.yaml
  # Cluster-specific Helm chart configuration (contains all values)
  - graylog-helmchart.yaml
  # Syslog service for UniFi CEF input (NodePort for external access)
  - graylog-syslog-service.yaml
  # OpenSearch bootstrap password workaround (MutatingAdmissionWebhook)
  - opensearch-bootstrap-webhook-issuer.yaml
  - opensearch-bootstrap-webhook-server.yaml
  - opensearch-bootstrap-webhook-certificate.yaml
  - opensearch-bootstrap-webhook.yaml
  # CA bundle injection job (runs after certificate creation)
  - opensearch-bootstrap-webhook-ca-bundle-job.yaml
  # Index configuration documentation (reference only, not deployed)
  # - graylog-index-config.yaml  # Uncomment if you want to reference this file

commonLabels:
  app: graylog
  managed-by: gitops
  cluster: nprd-apps

# Exclude webhook resources from commonLabels to prevent immutable selector conflicts
# The webhook Deployment/Service selector must remain app=opensearch-bootstrap-webhook
patchesStrategicMerge:
  - opensearch-bootstrap-webhook-selector-patch.yaml
  - graylog-secret-patch.yaml