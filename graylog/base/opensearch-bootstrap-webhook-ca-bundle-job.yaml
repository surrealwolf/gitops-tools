# OpenSearch Bootstrap Webhook CA Bundle Injection Job
#
# This Job automatically injects the CA bundle into the MutatingWebhookConfiguration
# after the certificate is created by cert-manager.
#
# The Job runs once after deployment to patch the MutatingWebhookConfiguration with
# the CA bundle extracted from the certificate secret.
#
# Prerequisites:
#   - Certificate secret must exist: opensearch-bootstrap-webhook-cert
#   - MutatingWebhookConfiguration must exist: opensearch-bootstrap-password-webhook
#
# The Job is idempotent and can be re-run if needed.

apiVersion: batch/v1
kind: Job
metadata:
  name: opensearch-bootstrap-webhook-ca-bundle-injector
  namespace: managed-graylog
  labels:
    app: opensearch-bootstrap-webhook
    component: ca-bundle-injector
    managed-by: gitops
  annotations:
    # Job runs once after certificate is created
    # Note: Job will complete and remain in cluster for history (24 hours via ttlSecondsAfterFinished)
spec:
  # Run only once (don't restart on failure)
  backoffLimit: 3
  ttlSecondsAfterFinished: 86400  # Keep job for 24 hours after completion
  template:
    metadata:
      labels:
        app: opensearch-bootstrap-webhook
        component: ca-bundle-injector
        managed-by: gitops
    spec:
      serviceAccountName: opensearch-bootstrap-webhook-ca-bundle-injector
      restartPolicy: Never
      containers:
      - name: ca-bundle-injector
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          
          NAMESPACE="managed-graylog"
          SECRET_NAME="opensearch-bootstrap-webhook-cert"
          WEBHOOK_NAME="opensearch-bootstrap-password-webhook"
          
          echo "=== OpenSearch Bootstrap Webhook CA Bundle Injection ==="
          echo ""
          echo "Waiting for certificate secret to be ready..."
          
          # Wait for secret to exist (max 60 seconds)
          for i in {1..60}; do
            if kubectl get secret "$SECRET_NAME" -n "$NAMESPACE" &>/dev/null; then
              echo "✅ Certificate secret found"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "❌ ERROR: Certificate secret $SECRET_NAME not found in namespace $NAMESPACE after 60 seconds"
              exit 1
            fi
            echo "Waiting for secret... ($i/60)"
            sleep 1
          done
          
          echo ""
          echo "Extracting CA bundle from secret..."
          
          # Extract CA bundle (try ca.crt first, then tls.crt for self-signed)
          CA_BUNDLE=$(kubectl get secret "$SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.ca\.crt}' 2>/dev/null || echo "")
          
          if [ -z "$CA_BUNDLE" ]; then
            echo "CA bundle (ca.crt) not found. Trying tls.crt (self-signed certificate)..."
            CA_BUNDLE=$(kubectl get secret "$SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.tls\.crt}' 2>/dev/null || echo "")
          fi
          
          if [ -z "$CA_BUNDLE" ]; then
            echo "❌ ERROR: No certificate data found in secret $SECRET_NAME"
            exit 1
          fi
          
          echo "✅ CA bundle extracted ($(echo -n "$CA_BUNDLE" | wc -c) bytes)"
          echo ""
          
          echo "Waiting for MutatingWebhookConfiguration to be ready..."
          
          # Wait for webhook to exist (max 30 seconds)
          for i in {1..30}; do
            if kubectl get mutatingwebhookconfiguration "$WEBHOOK_NAME" &>/dev/null; then
              echo "✅ MutatingWebhookConfiguration found"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "❌ ERROR: MutatingWebhookConfiguration $WEBHOOK_NAME not found after 30 seconds"
              exit 1
            fi
            echo "Waiting for webhook configuration... ($i/30)"
            sleep 1
          done
          
          echo ""
          echo "Checking current CA bundle..."
          CURRENT_BUNDLE=$(kubectl get mutatingwebhookconfiguration "$WEBHOOK_NAME" -o jsonpath='{.webhooks[0].clientConfig.caBundle}' 2>/dev/null || echo "")
          
          if [ "$CA_BUNDLE" == "$CURRENT_BUNDLE" ]; then
            echo "✅ CA bundle is already set correctly"
            exit 0
          fi
          
          echo "Updating MutatingWebhookConfiguration with CA bundle..."
          kubectl patch mutatingwebhookconfiguration "$WEBHOOK_NAME" --type='json' \
            -p="[{\"op\": \"replace\", \"path\": \"/webhooks/0/clientConfig/caBundle\", \"value\": \"${CA_BUNDLE}\"}]"
          
          echo ""
          echo "✅ CA bundle successfully injected into MutatingWebhookConfiguration"
          echo ""
          echo "Verification:"
          VERIFIED_BUNDLE=$(kubectl get mutatingwebhookconfiguration "$WEBHOOK_NAME" -o jsonpath='{.webhooks[0].clientConfig.caBundle}' 2>/dev/null || echo "")
          if [ "$CA_BUNDLE" == "$VERIFIED_BUNDLE" ]; then
            echo "✅ Verified: CA bundle matches"
          else
            echo "⚠️  WARNING: CA bundle verification failed (but patch succeeded)"
          fi
          
          echo ""
          echo "=== CA Bundle Injection Complete ==="
        env:
        - name: NAMESPACE
          value: "managed-graylog"
        resources:
          requests:
            cpu: "100m"
            memory: "64Mi"
          limits:
            cpu: "200m"
            memory: "128Mi"
---
# ServiceAccount for CA bundle injector job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: opensearch-bootstrap-webhook-ca-bundle-injector
  namespace: managed-graylog
  labels:
    app: opensearch-bootstrap-webhook
    component: ca-bundle-injector
    managed-by: gitops
---
# ClusterRole for CA bundle injector (permissions to read secrets and patch webhook)
# Note: MutatingWebhookConfiguration is cluster-scoped, so ClusterRole is required
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: opensearch-bootstrap-webhook-ca-bundle-injector
  labels:
    app: opensearch-bootstrap-webhook
    component: ca-bundle-injector
    managed-by: gitops
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get"]
  resourceNames: ["opensearch-bootstrap-webhook-cert"]
  namespaces: ["managed-graylog"]
- apiGroups: ["admissionregistration.k8s.io"]
  resources: ["mutatingwebhookconfigurations"]
  verbs: ["get", "patch"]
  resourceNames: ["opensearch-bootstrap-password-webhook"]
---
# ClusterRoleBinding for CA bundle injector
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: opensearch-bootstrap-webhook-ca-bundle-injector
  labels:
    app: opensearch-bootstrap-webhook
    component: ca-bundle-injector
    managed-by: gitops
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: opensearch-bootstrap-webhook-ca-bundle-injector
subjects:
- kind: ServiceAccount
  name: opensearch-bootstrap-webhook-ca-bundle-injector
  namespace: managed-graylog
